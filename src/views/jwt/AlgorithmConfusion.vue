<template>
    <div class="root-div">
        <div class="vuln-info">
            <div class="header-div">JWTå®‰å…¨æ¼æ´ -- JWT ç®—æ³•æ··æ·†æ¼æ´</div>
            <div class="body-div">
                <el-tabs v-model="activeName" @tab-click="handleClick">
                    <el-tab-pane label="æ¼æ´æè¿°" name="first">
                        <div class="vuln-detail">
                            JWTç®—æ³•æ··æ·†æ¼æ´æ˜¯æŒ‡JWTéªŒè¯è¿‡ç¨‹ä¸­æ ¹æ®JWT headerä¸­çš„ç®—æ³•å­—æ®µåŠ¨æ€é€‰æ‹©éªŒè¯æ–¹å¼ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹ç®—æ³•ç±»å‹æ¥ç»•è¿‡éªŒè¯ã€‚<span style="color: red;">æ”»å‡»è€…å¯ä»¥è·å–RSAå…¬é’¥ï¼Œå°†å…¶ä½œä¸ºHMACå¯†é’¥æ¥ç­¾åHS256 JWT</span>ï¼ŒæœåŠ¡å™¨ä¼šé”™è¯¯åœ°ä½¿ç”¨å…¬é’¥éªŒè¯HS256ç­¾åï¼Œä»è€Œç»•è¿‡èº«ä»½éªŒè¯ã€‚
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="æ¼æ´å±å®³" name="second">
                        <div class="vuln-detail">
                            JWTç®—æ³•æ··æ·†æ¼æ´çš„å±å®³éå¸¸ä¸¥é‡ï¼Œæ”»å‡»è€…ä¸€æ—¦æˆåŠŸåˆ©ç”¨ï¼Œå°±å¯ä»¥ï¼š<br /><br />
                            èº«ä»½ä¼ªé€ ï¼šæ”»å‡»è€…å¯ä»¥ä¼ªé€ ä»»æ„ç”¨æˆ·çš„JWTä»¤ç‰Œï¼Œå†’å……å…¶ä»–ç”¨æˆ·èº«ä»½ï¼›<br />
                            æƒé™æå‡ï¼šæ”»å‡»è€…å¯ä»¥ä¿®æ”¹JWTä¸­çš„æƒé™ä¿¡æ¯ï¼Œè·å–æ›´é«˜æƒé™ï¼›<br />
                            ä¼šè¯åŠ«æŒï¼šæ”»å‡»è€…å¯ä»¥åŠ«æŒç”¨æˆ·çš„ä¼šè¯ï¼Œè¿›è¡Œæ¶æ„æ“ä½œï¼›<br />
                            æ•°æ®æ³„éœ²ï¼šæ”»å‡»è€…å¯ä»¥è®¿é—®æ•æ„Ÿæ•°æ®ï¼Œé€ æˆä¿¡æ¯æ³„éœ²ã€‚
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="å®‰å…¨ç¼–ç " name="third">
                        <div class="vuln-detail">
                            ã€å¿…é¡»ã€‘å›ºå®šJWTéªŒè¯ç®—æ³•
                            åœ¨JWTéªŒè¯æ—¶æ˜ç¡®æŒ‡å®šå…è®¸çš„ç­¾åç®—æ³•ï¼Œä¸è¦æ ¹æ®JWT headeråŠ¨æ€é€‰æ‹©ã€‚<br /><br />
                            ã€å¿…é¡»ã€‘æ‹’ç»ä¸æ”¯æŒçš„ç®—æ³•
                            æ˜ç¡®æ‹’ç»HS256ã€noneç­‰ä¸å®‰å…¨çš„ç®—æ³•ç±»å‹ã€‚<br /><br />
                            ã€å»ºè®®ã€‘ä½¿ç”¨å¯†é’¥ç™½åå•
                            ç»´æŠ¤ä¸€ä¸ªå…è®¸çš„å¯†é’¥åˆ—è¡¨ï¼Œåªæ¥å—é¢„å®šä¹‰çš„å¯†é’¥ã€‚<br /><br />
                            ã€å»ºè®®ã€‘ç®—æ³•å’Œå¯†é’¥åˆ†ç¦»
                            RSAå’ŒHMACä½¿ç”¨ä¸åŒçš„å¯†é’¥ï¼Œé¿å…å¯†é’¥é‡ç”¨ã€‚
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="å‚è€ƒæ–‡ç« " name="fourth">
                        <div class="vuln-detail">
                            <a href="https://portswigger.net/web-security/jwt/algorithm-confusion" target="_blank" style="text-decoration: underline;">ã€ŠJWTç®—æ³•æ··æ·†æ”»å‡»ã€‹</a>ï¼šBurp Suiteå®˜æ–¹å¯¹JWTç®—æ³•æ··æ·†æ¼æ´çš„è¯¦ç»†è¯´æ˜ã€‚<br />
                            <a href="https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/" target="_blank" style="text-decoration: underline;">ã€ŠJWTåº“ä¸­çš„å…³é”®æ¼æ´ã€‹</a>ï¼šäº†è§£JWTåº“ä¸­çš„å¸¸è§å®‰å…¨æ¼æ´ã€‚
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </div>
        <div class="code-demo">
            <el-row :gutter="20" class="grid-flex">
                <el-col :span="12">
                    <div class="grid-content bg-purple">
                        <el-row type="flex" justify="space-between" align="middle">
                            JWT RS256ç®—æ³•åŸºæœ¬ä½¿ç”¨
                            <div>
                                <el-button type="primary" round size="mini" @click="handleDemo">å»æµ‹è¯•</el-button>
                            </div>
                        </el-row>
                        <pre v-highlightjs><code class="java">// RS256 JWTç”Ÿæˆ - ä½¿ç”¨ç§é’¥ç­¾å

public static String generateRS256Jwt(Map&lt;String, Object&gt; claims) {
    String jwttoken = Jwts.builder()
            .signWith(SignatureAlgorithm.RS256, rsaKeyPair.getPrivate()) // ä½¿ç”¨ç§é’¥ç­¾å
            .setClaims(claims)
            .setExpiration(new Date(System.currentTimeMillis() + expire))
            .compact();
    return jwttoken;
}

// RS256 JWTéªŒè¯ - ä½¿ç”¨å…¬é’¥éªŒè¯
public static Claims parseRS256Jwt(String jwttoken) {
    Claims claims = Jwts.parser()
            .setSigningKey(rsaKeyPair.getPublic()) // ä½¿ç”¨å…¬é’¥éªŒè¯
            .parseClaimsJws(jwttoken)
            .getBody();
    return claims;
}</code></pre>
                    </div>
                </el-col>
            </el-row>
            <el-row :gutter="20" class="grid-flex">
                <!-- æ¼æ´ä»£ç  - JWTç®—æ³•æ··æ·†æ¼æ´ -->
                <el-col :span="12">
                    <div class="grid-content bg-purple">
                        <el-row type="flex" justify="space-between" align="middle">
                            æ¼æ´ä»£ç  - JWTç®—æ³•æ··æ·†æ¼æ´
                            <div>
                                <el-button type="danger" round size="mini" @click="handleVulnerability">å»æµ‹è¯•</el-button>
                            </div>
                        </el-row>
                        <pre v-highlightjs><code class="java">// æ˜“å—ç®—æ³•æ··æ·†æ”»å‡»çš„JWTéªŒè¯æ–¹æ³•
// å®Œå…¨æŒ‰ç…§Burp Suiteå®˜æ–¹æ–‡æ¡£çš„ä¼ªä»£ç å®ç°

public static Claims verifyVulnerable(String token, PublicKey publicKey) {
    try {
        // è§£æJWTè·å–header
        String[] parts = token.split("\\.");
        if (parts.length != 3) {
            throw new RuntimeException("Invalid JWT format");
        }
        
        // è·å–headerä¸­çš„ç®—æ³•ç±»å‹
        String headerJson = new String(java.util.Base64.getUrlDecoder().decode(parts[0]));
        String algorithm = extractAlgorithm(headerJson);
        
        // æ ¹æ®ç®—æ³•ç±»å‹é€‰æ‹©éªŒè¯æ–¹å¼ï¼ˆæ˜“å—æ”»å‡»çš„é€»è¾‘ï¼‰
        if ("RS256".equals(algorithm)) {
            // ä½¿ç”¨å…¬é’¥ä½œä¸ºRSAå…¬é’¥éªŒè¯
            return Jwts.parser()
                    .setSigningKey(publicKey)
                    .parseClaimsJws(token)
                    .getBody();
        } else if ("HS256".equals(algorithm)) {
            // å±é™©ï¼šä½¿ç”¨å…¬é’¥ä½œä¸ºHMACå¯†é’¥éªŒè¯
            // è¿™å°±æ˜¯ç®—æ³•æ··æ·†æ¼æ´çš„æ ¸å¿ƒï¼
            return Jwts.parser()
                    .setSigningKey(publicKey.getEncoded()) // å°†å…¬é’¥å­—èŠ‚ä½œä¸ºHMACå¯†é’¥
                    .parseClaimsJws(token)
                    .getBody();
        } else {
            throw new RuntimeException("Unsupported algorithm: " + algorithm);
        }
    } catch (Exception e) {
        throw new RuntimeException("JWT verification failed: " + e.getMessage(), e);
    }
}
</code></pre>
                    </div>
                </el-col>
                <!-- å®‰å…¨ä»£ç  - JWTç®—æ³•æ··æ·†æ¼æ´ä¿®å¤ -->
                <el-col :span="12">
                    <div class="grid-content bg-purple">
                        <el-row type="flex" justify="space-between" align="middle">
                            å®‰å…¨ä»£ç  - JWTç®—æ³•æ··æ·†æ¼æ´ä¿®å¤
                            <div>
                                <el-button type="success" round size="mini" @click="handleSecure">å»æµ‹è¯•</el-button>
                            </div>
                        </el-row>
                        <pre v-highlightjs><code class="java">// å®‰å…¨çš„JWTéªŒè¯æ–¹æ³• - ä¿®å¤ç®—æ³•æ··æ·†æ¼æ´
// å¼ºåˆ¶æ ¡éªŒJWTå¿…é¡»æ˜¯RS256ç®—æ³•ï¼Œä¸å…è®¸å…¶ä»–ç®—æ³•

public static Claims verifySecure(String token) {
    try {
        // è§£æJWTè·å–header
        String[] parts = token.split("\\.");
        if (parts.length != 3) {
            throw new RuntimeException("Invalid JWT format");
        }
        
        // è·å–headerä¸­çš„ç®—æ³•ç±»å‹
        String headerJson = new String(java.util.Base64.getUrlDecoder().decode(parts[0]));
        String algorithm = extractAlgorithm(headerJson);
        
        // å¼ºåˆ¶æ ¡éªŒç®—æ³•å¿…é¡»æ˜¯RS256
        if (!"RS256".equals(algorithm)) {
            throw new RuntimeException("Only RS256 algorithm is allowed, but found: " + algorithm);
        }
        
        // ä½¿ç”¨å…¬é’¥éªŒè¯RS256ç­¾å
        return Jwts.parser()
                .setSigningKey(rsaKeyPair.getPublic())
                .parseClaimsJws(token)
                .getBody();
    } catch (Exception e) {
        throw new RuntimeException("Secure JWT verification failed: " + e.getMessage(), e);
    }
}
</code></pre>
                    </div>
                </el-col>
            </el-row>
        </div>

        <!-- RS256å­¦ä¹ å¯¹è¯æ¡† -->
        <el-dialog :visible.sync="demoDialogVisible" width="800px" :show-close="true" :close-on-click-modal="true" @close="handleDemoDialogClose">
            <div slot="title" style="text-align: center; font-size: 18px;">
                JWT RS256ç®—æ³•åŸºæœ¬ä½¿ç”¨
            </div>
            <div class="test-container">
                <!-- 1. ç™»å½•éƒ¨åˆ† -->
                <div class="test-section">
                    <h3>1. ç”¨æˆ·ç™»å½• <span style="color: red; font-size: 14px; font-weight: normal;">(æµ‹è¯•è´¦å·: zhangsan/123)</span></h3>
                    <el-form :model="loginForm" :rules="loginRules" ref="loginForm" label-width="80px" inline>
                        <el-form-item label="ç”¨æˆ·å" prop="username">
                            <el-input v-model="loginForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="width: 200px;"></el-input>
                        </el-form-item>
                        <el-form-item label="å¯†ç " prop="password">
                            <el-input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 200px;"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="handleLogin">ç™»å½•</el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <!-- 2. JWTæ ¡éªŒæµ‹è¯• -->
                <div class="test-section">
                    <h3>2. JWTæ ¡éªŒæµ‹è¯•</h3>
                    <div class="jwt-input-section">
                        <el-input
                            v-model="jwtToken"
                            type="textarea"
                            :rows="3"
                            placeholder="JWT Tokenå°†åœ¨è¿™é‡Œæ˜¾ç¤º"
                            readonly>
                        </el-input>
                    </div>
                    <div class="jwt-test-buttons">
                        <el-button type="primary" @click="verifyJwt" :disabled="!jwtToken">
                            æ ¡éªŒRS256 JWT
                        </el-button>
                    </div>
                    <div v-if="verifyResult" class="result-box">
                        <el-alert
                            :title="verifyResult.success ? 'æ ¡éªŒæˆåŠŸ' : 'æ ¡éªŒå¤±è´¥'"
                            :description="verifyResult.message"
                            :type="verifyResult.success ? 'success' : 'error'"
                            show-icon>
                        </el-alert>
                    </div>
                </div>

                <!-- 3. JWTç»“æ„è§£æ -->
                <div class="test-section">
                    <h3>3. JWTç»“æ„è§£æ <span style="color: red; font-size: 14px; font-weight: normal;">(æŸ¥çœ‹Headerå’ŒPayload)</span></h3>
                    <div class="jwt-test-buttons">
                        <el-button type="info" @click="parseJwt" :disabled="!jwtToken">
                            è§£æJWTç»“æ„
                        </el-button>
                    </div>
                    <div v-if="parseResult" class="jwt-input-section">
                        <h4>Headerï¼ˆå¤´éƒ¨ï¼‰ï¼š</h4>
                        <el-input
                            v-model="parseResult.header"
                            type="textarea"
                            :rows="2"
                            readonly>
                        </el-input>
                    </div>
                    <div v-if="parseResult" class="jwt-input-section">
                        <h4>Payloadï¼ˆè½½è·ï¼‰ï¼š</h4>
                        <el-input
                            v-model="parseResult.payload"
                            type="textarea"
                            :rows="4"
                            readonly>
                        </el-input>
                    </div>
                </div>

            </div>
        </el-dialog>


        <!-- JWTç®—æ³•æ··æ·†æ¼æ´å­¦ä¹ å¯¹è¯æ¡† -->
        <el-dialog :visible.sync="vulnerabilityDialogVisible" width="800px" :show-close="true" :close-on-click-modal="true" @close="handleVulnerabilityDialogClose">
            <div slot="title" style="text-align: center; font-size: 18px;">
                JWTç®—æ³•æ··æ·†æ¼æ´æµ‹è¯•
            </div>
            <div class="test-container">
                <!-- æ”»å‡»æ­¥éª¤è¯´æ˜ -->
                <div class="test-section">
                    <h3>ğŸ¯ æ”»å‡»æ­¥éª¤è¯´æ˜</h3>
                    <el-alert
                        title="JWTç®—æ³•æ··æ·†æ”»å‡»å¤ç°æ­¥éª¤"
                        type="warning"
                        :closable="false"
                        show-icon>
                        <div style="text-align: left; line-height: 1.8;">
                            <p><strong>ç¬¬1æ­¥ï¼š</strong> ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•ï¼Œè·å–æ­£å¸¸çš„RS256 JWTä»¤ç‰Œ</p>
                            <p><strong>ç¬¬2æ­¥ï¼š</strong> ç‚¹å‡»"è·å–æ”»å‡»å…¬é’¥"ï¼Œè·å–Base64æ ¼å¼çš„RSAå…¬é’¥</p>
                            <p><strong>ç¬¬3æ­¥ï¼š</strong> ä½¿ç”¨Burp Suite JWT Editoræ’ä»¶ï¼š</p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>åˆ›å»ºæ–°çš„Symmetric Key</li>
                                <li>å°†è·å–çš„Base64å…¬é’¥ä½œä¸ºHMACå¯†é’¥</li>
                                <li>ä¿®æ”¹JWT headerä¸º <code>{"alg":"HS256"}</code></li>
                                <li>ä¿®æ”¹payloadä¸ºå…¶ä»–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚lisiï¼‰</li>
                                <li>ä½¿ç”¨å…¬é’¥é‡æ–°ç­¾åJWT</li>
                            </ul>
                            <p><strong>ç¬¬4æ­¥ï¼š</strong> å°†ä¼ªé€ çš„JWTå‘é€åˆ°"JWTæ ¡éªŒæµ‹è¯•"æ¥å£ï¼ŒéªŒè¯æ”»å‡»æˆåŠŸ</p>
                            <p style="color: #E6A23C; margin-top: 10px;">
                                <i class="el-icon-warning"></i> 
                                <strong>æ¼æ´åŸç†ï¼š</strong>æœåŠ¡å™¨æ ¹æ®JWT headerä¸­çš„algå­—æ®µåŠ¨æ€é€‰æ‹©éªŒè¯ç®—æ³•ï¼Œå½“alg=HS256æ—¶ï¼Œé”™è¯¯åœ°å°†RSAå…¬é’¥å½“ä½œHMACå¯†é’¥ä½¿ç”¨
                            </p>
                        </div>
                    </el-alert>
                </div>

                <!-- 1. ç™»å½•éƒ¨åˆ† -->
                <div class="test-section">
                    <h3>1. ç”¨æˆ·ç™»å½• <span style="color: red; font-size: 14px; font-weight: normal;">(æµ‹è¯•è´¦å·: zhangsan/123)</span></h3>
                    <el-form :model="loginForm" :rules="loginRules" ref="vulnerabilityLoginForm" label-width="70px" inline>
                        <el-form-item label="ç”¨æˆ·å" prop="username">
                            <el-input v-model="loginForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="width: 150px;"></el-input>
                        </el-form-item>
                        <el-form-item label="å¯†ç " prop="password">
                            <el-input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 150px;"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="handleVulnerabilityLogin">ç™»å½•</el-button>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="getPublicKey">è·å–å…¬é’¥</el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <!-- æ”»å‡»å…¬é’¥æ˜¾ç¤ºåŒºåŸŸ -->
                <div v-if="attackKeyInfo" class="test-section">
                    <div class="jwt-input-section">
                        <h4>æ”»å‡»å…¬é’¥ï¼ˆBase64æ ¼å¼ï¼‰ï¼š</h4>
                        <el-input
                            v-model="attackKeyInfo.publicKeyBase64"
                            type="textarea"
                            :rows="4"
                            readonly>
                        </el-input>
                    </div>
                </div>

                <!-- 2. JWTæ ¡éªŒæµ‹è¯• -->
                <div class="test-section">
                    <h3>2. JWTæ ¡éªŒæµ‹è¯•</h3>
                    <div class="jwt-input-section">
                        <el-input
                            v-model="vulnerabilityJwtToken"
                            type="textarea"
                            :rows="3"
                            placeholder="JWT Tokenå°†åœ¨è¿™é‡Œæ˜¾ç¤º"
                            readonly>
                        </el-input>
                    </div>
                    <div class="jwt-test-buttons">
                        <el-button type="primary" @click="verifyVulnerableJwt" :disabled="!vulnerabilityJwtToken">
                            æ ¡éªŒJWT
                        </el-button>
                    </div>
                    <div v-if="verifyResult" class="result-box">
                        <el-alert
                            :title="verifyResult.success ? 'æ ¡éªŒæˆåŠŸ' : 'æ ¡éªŒå¤±è´¥'"
                            :description="verifyResult.message"
                            :type="verifyResult.success ? 'success' : 'error'"
                            show-icon>
                        </el-alert>
                    </div>
                </div>

                <!-- 3. JWTç»“æ„è§£æ -->
                <div class="test-section">
                    <h3>3. JWTç»“æ„è§£æ <span style="color: red; font-size: 14px; font-weight: normal;">(æŸ¥çœ‹Headerå’ŒPayload)</span></h3>
                    <div class="jwt-test-buttons">
                        <el-button type="info" @click="parseJwt" :disabled="!jwtToken">
                            è§£æJWTç»“æ„
                        </el-button>
                    </div>
                    <div v-if="parseResult" class="jwt-input-section">
                        <h4>Headerï¼ˆå¤´éƒ¨ï¼‰ï¼š</h4>
                        <el-input
                            v-model="parseResult.header"
                            type="textarea"
                            :rows="2"
                            readonly>
                        </el-input>
                    </div>
                    <div v-if="parseResult" class="jwt-input-section">
                        <h4>Payloadï¼ˆè½½è·ï¼‰ï¼š</h4>
                        <el-input
                            v-model="parseResult.payload"
                            type="textarea"
                            :rows="4"
                            readonly>
                        </el-input>
                    </div>
                </div>
            </div>
        </el-dialog>

        <!-- JWTå®‰å…¨éªŒè¯æµ‹è¯•å¯¹è¯æ¡† -->
        <el-dialog :visible.sync="secureDialogVisible" width="800px" :show-close="true" :close-on-click-modal="true" @close="handleSecureDialogClose">
            <div slot="title" style="text-align: center; font-size: 18px;">
                JWTå®‰å…¨éªŒè¯æµ‹è¯•
            </div>
            <div class="test-container">
                <!-- æ”»å‡»æ­¥éª¤è¯´æ˜ -->
                <div class="test-section">
                    <h3>ğŸ¯ å®‰å…¨ä¿®å¤è¯´æ˜</h3>
                    <el-alert
                        title="JWTç®—æ³•æ··æ·†æ¼æ´ä¿®å¤æ–¹æ¡ˆ"
                        type="success"
                        :closable="false"
                        show-icon>
                        <div style="text-align: left; line-height: 1.8;">
                            <p><strong>ä¿®å¤åŸç†ï¼š</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>å¼ºåˆ¶æ ¡éªŒJWT headerä¸­çš„algå­—æ®µå¿…é¡»æ˜¯"RS256"</li>
                                <li>å¦‚æœå‘ç°å…¶ä»–ç®—æ³•ï¼ˆå¦‚HS256ï¼‰ï¼Œç›´æ¥æ‹’ç»éªŒè¯</li>
                                <li>åªå…è®¸ä½¿ç”¨RSAå…¬é’¥éªŒè¯RS256ç­¾åçš„JWT</li>
                                <li>å½»åº•é˜²æ­¢ç®—æ³•æ··æ·†æ”»å‡»</li>
                            </ul>
                            <p style="color: #67C23A; margin-top: 10px;">
                                <i class="el-icon-success"></i> 
                                <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>ç°åœ¨å³ä½¿ç”¨æ”»å‡»è€…ä½¿ç”¨HS256ç®—æ³•ä¼ªé€ JWTï¼Œå®‰å…¨éªŒè¯æ¥å£ä¹Ÿä¼šæ‹’ç»éªŒè¯ï¼Œä»è€Œé˜²æ­¢ç®—æ³•æ··æ·†æ”»å‡»
                            </p>
                        </div>
                    </el-alert>
                </div>

                <!-- 1. ç™»å½•éƒ¨åˆ† -->
                <div class="test-section">
                    <h3>1. ç”¨æˆ·ç™»å½• <span style="color: red; font-size: 14px; font-weight: normal;">(æµ‹è¯•è´¦å·: zhangsan/123)</span></h3>
                    <el-form :model="loginForm" :rules="loginRules" ref="secureLoginForm" label-width="70px" inline>
                        <el-form-item label="ç”¨æˆ·å" prop="username">
                            <el-input v-model="loginForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="width: 150px;"></el-input>
                        </el-form-item>
                        <el-form-item label="å¯†ç " prop="password">
                            <el-input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 150px;"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="handleSecureLogin">ç™»å½•</el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <!-- æ”»å‡»å…¬é’¥æ˜¾ç¤ºåŒºåŸŸ -->
                <div v-if="attackKeyInfo" class="test-section">
                    <div class="jwt-input-section">
                        <h4>æ”»å‡»å…¬é’¥ï¼ˆBase64æ ¼å¼ï¼‰ï¼š</h4>
                        <el-input
                            v-model="attackKeyInfo.publicKeyBase64"
                            type="textarea"
                            :rows="4"
                            readonly>
                        </el-input>
                    </div>
                </div>

                <!-- 2. JWTæ ¡éªŒæµ‹è¯• -->
                <div class="test-section">
                    <h3>2. JWTæ ¡éªŒæµ‹è¯•</h3>
                    <div class="jwt-input-section">
                        <h4>JWT Tokenï¼š</h4>
                        <el-input
                            v-model="secureJwtToken"
                            type="textarea"
                            :rows="3"
                            placeholder="JWT Tokenå°†åœ¨è¿™é‡Œæ˜¾ç¤º"
                            readonly>
                        </el-input>
                    </div>
                    <div class="jwt-test-buttons">
                        <el-button type="success" @click="verifySecureJwt" :disabled="!secureJwtToken">
                            å®‰å…¨æ ¡éªŒJWT
                        </el-button>
                    </div>
                    <div v-if="secureVerifyResult" class="result-box">
                        <el-alert
                            :title="secureVerifyResult.success ? 'å®‰å…¨æ ¡éªŒæˆåŠŸ' : 'å®‰å…¨æ ¡éªŒå¤±è´¥'"
                            :description="secureVerifyResult.message"
                            :type="secureVerifyResult.success ? 'success' : 'error'"
                            show-icon>
                        </el-alert>
                    </div>
                </div>
            </div>
        </el-dialog>
    </div>
</template>

<script>
import { 
    rs256Login, 
    verifyJwt, 
    getPublicKey,
    verifyVulnerableJwt,
    verifySecureJwt
} from '@/api/jwt'

export default {
    data() {
        return {
            activeName: 'first',
            demoDialogVisible: false,
            vulnerabilityDialogVisible: false,
            secureDialogVisible: false,
            loginForm: {
                username: '',
                password: ''
            },
            loginRules: {
                username: [
                    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }
                ],
                password: [
                    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' }
                ]
            },
            jwtToken: '',
            verifyResult: null,
            parseResult: null,
            attackKeyInfo: null,
            vulnerableVerifyResult: null,
            vulnerabilityJwtToken: '',
            secureJwtToken: '',
            secureVerifyResult: null
        }
    },
    methods: {
        handleClick(tab, event) {
            // å¤„ç†æ ‡ç­¾é¡µç‚¹å‡»äº‹ä»¶
        },
        handleDemo() {
            this.demoDialogVisible = true
            this.loginForm.username = 'zhangsan'
            this.loginForm.password = '123'
            this.resetDemoData()
        },
        handleVulnerability() {
            this.vulnerabilityDialogVisible = true
            this.loginForm.username = 'zhangsan'
            this.loginForm.password = '123'
            this.resetVulnerabilityData()
        },
        handleSecure() {
            this.secureDialogVisible = true
            this.loginForm.username = 'zhangsan'
            this.loginForm.password = '123'
            this.resetSecureData()
        },
        resetDemoData() {
            this.jwtToken = ''
            this.verifyResult = null
            this.parseResult = null
        },
        resetVulnerabilityData() {
            this.attackKeyInfo = null
            this.vulnerableVerifyResult = null
            this.vulnerabilityJwtToken = ''
        },
        resetSecureData() {
            this.secureJwtToken = ''
            this.secureVerifyResult = null
            this.attackKeyInfo = null
        },
        handleLogin() {
            this.$refs.loginForm.validate((valid) => {
                if (valid) {
                    rs256Login(this.loginForm).then(response => {
                        this.jwtToken = response.data
                        localStorage.setItem('jwt', response.data)
                        this.$message.success('RS256ç™»å½•æˆåŠŸï¼ŒJWTå·²ç”Ÿæˆ')
                    }).catch(error => {
                        if (error.message && error.message !== 'Error' && error.message !== 'error') {
                            this.$message.error('ç™»å½•å¤±è´¥ï¼š' + error.message)
                        }
                    })
                }
            })
        },
        handleVulnerabilityLogin() {
            this.$refs.vulnerabilityLoginForm.validate((valid) => {
                if (valid) {
                    rs256Login(this.loginForm).then(response => {
                        // ç™»å½•æˆåŠŸåè®¾ç½®JWT
                        this.vulnerabilityJwtToken = response.data
                        localStorage.setItem('jwt', response.data)
                        this.$message.success('RS256ç™»å½•æˆåŠŸï¼ŒJWTå·²ç”Ÿæˆï¼Œç°åœ¨å¯ä»¥è¿›è¡Œç®—æ³•æ··æ·†æ”»å‡»æµ‹è¯•')
                    }).catch(error => {
                        if (error.message && error.message !== 'Error' && error.message !== 'error') {
                            this.$message.error('ç™»å½•å¤±è´¥ï¼š' + error.message)
                        }
                    })
                }
            })
        },
        handleSecureLogin() {
            this.$refs.secureLoginForm.validate((valid) => {
                if (valid) {
                    rs256Login(this.loginForm).then(response => {
                        // ç™»å½•æˆåŠŸåè®¾ç½®JWT
                        this.secureJwtToken = response.data
                        localStorage.setItem('jwt', response.data)
                        this.$message.success('RS256ç™»å½•æˆåŠŸï¼ŒJWTå·²ç”Ÿæˆï¼Œç°åœ¨å¯ä»¥è¿›è¡Œå®‰å…¨éªŒè¯æµ‹è¯•')
                        // è‡ªåŠ¨è·å–æ”»å‡»å…¬é’¥
                        this.getPublicKey()
                    }).catch(error => {
                        if (error.message && error.message !== 'Error' && error.message !== 'error') {
                            this.$message.error('ç™»å½•å¤±è´¥ï¼š' + error.message)
                        }
                    })
                }
            })
        },
        async verifyJwt() {
            if (!this.jwtToken) {
                this.$message.warning('è¯·å…ˆç”ŸæˆJWT')
                return
            }

            try {
                const response = await verifyJwt(this.jwtToken)
                if (response.code === 0) {
                    this.verifyResult = {
                        success: true,
                        message: `JWTéªŒè¯æˆåŠŸï¼ç”¨æˆ·ï¼š${response.data.username}ï¼Œå§“åï¼š${response.data.name}`
                    }
                    this.$message.success('JWTéªŒè¯æˆåŠŸ')
                } else {
                    this.verifyResult = {
                        success: false,
                        message: 'JWTéªŒè¯å¤±è´¥ï¼š' + response.msg
                    }
                    this.$message.error('JWTéªŒè¯å¤±è´¥')
                }
            } catch (error) {
                this.verifyResult = {
                    success: false,
                    message: 'JWTéªŒè¯å¤±è´¥ï¼š' + error.message
                }
                this.$message.error('JWTéªŒè¯å¤±è´¥: ' + error.message)
            }
        },
        parseJwt() {
            if (!this.jwtToken) {
                this.$message.warning('è¯·å…ˆç”ŸæˆJWT')
                return
            }

            try {
                // å‰ç«¯ç›´æ¥è§£æJWTç»“æ„
                const parts = this.jwtToken.split('.')
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format')
                }

                // å®‰å…¨çš„Base64è§£ç å‡½æ•°ï¼Œæ”¯æŒUTF-8
                const safeBase64Decode = (str) => {
                    // æ·»åŠ padding
                    str = str.replace(/-/g, '+').replace(/_/g, '/')
                    while (str.length % 4) {
                        str += '='
                    }
                    // ä½¿ç”¨decodeURIComponentå¤„ç†UTF-8å­—ç¬¦
                    return decodeURIComponent(escape(atob(str)))
                }

                // è§£æHeader
                const header = JSON.parse(safeBase64Decode(parts[0]))
                
                // è§£æPayload
                const payload = JSON.parse(safeBase64Decode(parts[1]))

                this.parseResult = {
                    header: JSON.stringify(header, null, 2),
                    payload: JSON.stringify(payload, null, 2)
                }
                this.$message.success('JWTè§£ææˆåŠŸ')
            } catch (error) {
                this.$message.error('JWTè§£æå¤±è´¥: ' + error.message)
            }
        },
        handleDemoDialogClose() {
            this.resetDemoData()
            localStorage.removeItem('jwt')
        },
        handleVulnerabilityDialogClose() {
            this.resetVulnerabilityData()
            localStorage.removeItem('jwt')
        },
        async getPublicKey() {
            try {
                const response = await getPublicKey()
                if (response.code === 0) {
                    this.attackKeyInfo = response.data
                    this.$message.success('è·å–æ”»å‡»å…¬é’¥æˆåŠŸ')
                } else {
                    this.$message.error('è·å–æ”»å‡»å…¬é’¥å¤±è´¥')
                }
            } catch (error) {
                this.$message.error('è·å–æ”»å‡»å…¬é’¥å¤±è´¥: ' + error.message)
            }
        },
        async verifyVulnerableJwt() {
            if (!this.vulnerabilityJwtToken) {
                this.$message.warning('è¯·å…ˆç”ŸæˆJWT')
                return
            }

            try {
                const response = await verifyVulnerableJwt(this.vulnerabilityJwtToken)
                if (response.code === 0) {
                    this.verifyResult = {
                        success: true,
                        message: `JWTéªŒè¯æˆåŠŸï¼ç”¨æˆ·ï¼š${response.data.username}ï¼Œå§“åï¼š${response.data.name}`
                    }
                    this.$message.success('JWTéªŒè¯æˆåŠŸ')
                } else {
                    this.verifyResult = {
                        success: false,
                        message: 'JWTéªŒè¯å¤±è´¥ï¼š' + response.msg
                    }
                    this.$message.error('JWTéªŒè¯å¤±è´¥')
                }
            } catch (error) {
                this.verifyResult = {
                    success: false,
                    message: 'JWTéªŒè¯å¤±è´¥: ' + error.message
                }
                this.$message.error('JWTéªŒè¯å¤±è´¥: ' + error.message)
            }
        },
        async verifySecureJwt() {
            if (!this.secureJwtToken) {
                this.$message.warning('è¯·å…ˆç”ŸæˆJWT')
                return
            }

            try {
                const response = await verifySecureJwt(this.secureJwtToken)
                if (response.code === 0) {
                    this.secureVerifyResult = {
                        success: true,
                        message: `å®‰å…¨JWTéªŒè¯æˆåŠŸï¼ç”¨æˆ·ï¼š${response.data.username}ï¼Œå§“åï¼š${response.data.name}`
                    }
                    this.$message.success('å®‰å…¨JWTéªŒè¯æˆåŠŸ')
                } else {
                    this.secureVerifyResult = {
                        success: false,
                        message: 'å®‰å…¨JWTéªŒè¯å¤±è´¥ï¼š' + response.msg
                    }
                    this.$message.error('å®‰å…¨JWTéªŒè¯å¤±è´¥')
                }
            } catch (error) {
                this.secureVerifyResult = {
                    success: false,
                    message: 'å®‰å…¨JWTéªŒè¯å¤±è´¥ï¼š' + error.message
                }
                this.$message.error('å®‰å…¨JWTéªŒè¯å¤±è´¥: ' + error.message)
            }
        },
        handleSecureDialogClose() {
            this.resetSecureData()
            localStorage.removeItem('jwt')
        }
    }
}
</script>

<style>
.vuln-info {
    border-radius: 10px;
    margin-left: 20px;
    margin-right: 20px;
    margin-bottom: 20px;
    margin-top: 10px;
}

.header-div {
    font-size: 24px;
    color: #409EFF;
    font-weight: bold;
    padding: 10px;
    justify-content: center;
    align-items: center;
    border-bottom: 1px solid #ccc;
}

.body-div {
    padding: 10px;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    font-size: 14px;
}

.vuln-detail {
    background-color: #dce9f8;
    padding: 10px;
}

.code-demo {
    margin: 20px;
    border-top: 1px solid #ccc;
    padding-top: 20px;
}

pre code {
    font-size: 12px;
}

.el-row {
    margin-bottom: 20px;
}

.el-row:last-child {
    margin-bottom: 0;
}

.el-col {
    border-radius: 4px;
}

.bg-purple-dark {
    background: #99a9bf;
}

.bg-purple {
    background: #d3dce6;
}

.bg-purple-light {
    background: #e5e9f2;
}

.grid-content {
    border-radius: 4px;
    height: 100%;
    padding: 10px;
}

.grid-flex {
    display: flex;
    align-items: stretch;
}

.row-bg {
    padding: 10px 0;
    background-color: #f9fafc;
}

.test-container {
    padding: 20px;
}

.test-section {
    margin-bottom: 30px;
    padding: 20px;
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    background-color: #fafafa;
}

.test-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #409EFF;
    font-size: 16px;
}

.jwt-input-section {
    margin-bottom: 15px;
}

.jwt-test-buttons {
    margin-bottom: 15px;
}

.jwt-test-buttons .el-button {
    margin-right: 10px;
}

.result-box {
    margin-top: 15px;
}
</style>
