<template>
    <div class="root-div">
        <div class="vuln-info">
            <div class="header-div">CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ¼æ´</div>
            <div class="body-div">
                <el-tabs v-model="activeName" @tab-click="handleClick">
                    <el-tab-pane label="æ¼æ´æè¿°" name="first">
                        <div class="vuln-detail">
                            CSRFï¼ˆCross-Site Request Forgeryï¼Œè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ˜¯ä¸€ç§ç½‘ç»œæ”»å‡»æ–¹å¼ï¼Œæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·åœ¨å·²è®¤è¯çš„ç½‘ç«™ä¸Šæ‰§è¡Œéé¢„æœŸçš„æ“ä½œã€‚è¿™ç§æ”»å‡»åˆ©ç”¨äº†Webåº”ç”¨å¯¹ç”¨æˆ·æµè§ˆå™¨çš„ä¿¡ä»»æœºåˆ¶ã€‚
                            <br /><br />
                            <span style="color: red;">æ”»å‡»åŸç†ï¼š</span>
                            <br />
                            1. ç”¨æˆ·ç™»å½•ç›®æ ‡ç½‘ç«™ï¼Œè·å¾—è®¤è¯Cookie
                            <br />
                            2. ç”¨æˆ·è®¿é—®æ”»å‡»è€…æ§åˆ¶çš„æ¶æ„ç½‘ç«™
                            <br />
                            3. æ¶æ„ç½‘ç«™è‡ªåŠ¨å‘ç›®æ ‡ç½‘ç«™å‘é€è¯·æ±‚
                            <br />
                            4. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ç”¨æˆ·çš„è®¤è¯Cookie
                            <br />
                            5. ç›®æ ‡ç½‘ç«™è¯¯è®¤ä¸ºè¿™æ˜¯ç”¨æˆ·çš„åˆæ³•æ“ä½œ
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="æ¼æ´å±å®³" name="second">
                        <div class="vuln-detail">
                            CSRFæ”»å‡»å¯ä»¥é€ æˆä¸¥é‡çš„ä¸šåŠ¡å®‰å…¨é£é™©ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
                            <br /><br />
                            <span style="color: red;">å¸¸è§æ”»å‡»åœºæ™¯ï¼š</span>
                            <br />
                            â€¢ èµ„é‡‘è½¬ç§»ï¼šé“¶è¡Œè½¬è´¦ã€æ”¯ä»˜æ“ä½œ
                            <br />
                            â€¢ è´¦æˆ·æ“ä½œï¼šä¿®æ”¹å¯†ç ã€åˆ é™¤è´¦æˆ·
                            <br />
                            â€¢ æ•°æ®ç¯¡æ”¹ï¼šä¿®æ”¹ä¸ªäººä¿¡æ¯ã€åˆ é™¤æ•°æ®
                            <br />
                            â€¢ æƒé™æå‡ï¼šæ·»åŠ ç®¡ç†å‘˜æƒé™
                            <br />
                            â€¢ æ¶æ„æ“ä½œï¼šå‘é€åƒåœ¾é‚®ä»¶ã€å‘å¸ƒæ¶æ„å†…å®¹
                            <br /><br />
                            <span style="color: red;">å½±å“èŒƒå›´ï¼š</span>
                            <br />
                            â€¢ æ‰€æœ‰ä¾èµ–Cookieè¿›è¡Œèº«ä»½è®¤è¯çš„Webåº”ç”¨
                            <br />
                            â€¢ ç‰¹åˆ«æ˜¯é‡‘èã€ç”µå•†ã€ç¤¾äº¤ç­‰æ•æ„Ÿåº”ç”¨
                            <br />
                            â€¢ å½±å“æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="å®‰å…¨ç¼–ç " name="third">
                        <div class="vuln-detail">
                            <span style="color: red;">ã€å¿…é¡»ã€‘CSRF TokenéªŒè¯</span>
                            <br />
                            ä¸ºæ¯ä¸ªç”¨æˆ·ä¼šè¯ç”Ÿæˆå”¯ä¸€çš„CSRF Tokenï¼Œå¹¶åœ¨æ‰€æœ‰çŠ¶æ€æ”¹å˜æ“ä½œä¸­éªŒè¯è¯¥Tokenã€‚
                            <br /><br />
                            <span style="color: red;">ã€å¿…é¡»ã€‘SameSite Cookieå±æ€§</span>
                            <br />
                            è®¾ç½®Cookieçš„SameSiteå±æ€§ä¸ºStrictæˆ–Laxï¼Œé˜²æ­¢è·¨ç«™è¯·æ±‚æºå¸¦Cookieã€‚
                            <br /><br />
                            <span style="color: red;">ã€å»ºè®®ã€‘éªŒè¯Refererå¤´</span>
                            <br />
                            æ£€æŸ¥HTTP Refererå¤´ï¼Œç¡®ä¿è¯·æ±‚æ¥æºäºå¯ä¿¡åŸŸåã€‚
                            <br /><br />
                            <span style="color: red;">ã€å»ºè®®ã€‘åŒé‡æäº¤Cookie</span>
                            <br />
                            åœ¨Cookieå’Œè¯·æ±‚å‚æ•°ä¸­éƒ½åŒ…å«CSRF Tokenï¼ŒéªŒè¯ä¸¤è€…æ˜¯å¦ä¸€è‡´ã€‚
                            <br /><br />
                            <span style="color: red;">ã€å»ºè®®ã€‘è‡ªå®šä¹‰HTTPå¤´</span>
                            <br />
                            ä½¿ç”¨è‡ªå®šä¹‰HTTPå¤´ä¼ é€’CSRF Tokenï¼Œé¿å…åœ¨URLä¸­æš´éœ²ã€‚
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="å‚è€ƒæ–‡ç« " name="fourth">
                        <div class="vuln-detail">
                            <a href="https://owasp.org/www-community/attacks/csrf" target="_blank" style="text-decoration: underline;">ã€ŠOWASP CSRFæ”»å‡»é˜²æŠ¤æŒ‡å—ã€‹</a>ï¼šæƒå¨çš„CSRFé˜²æŠ¤æœ€ä½³å®è·µã€‚<br />
                            <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies#samesite_cookies" target="_blank" style="text-decoration: underline;">ã€ŠSameSite Cookieè¯¦è§£ã€‹</a>ï¼šæ·±å…¥äº†è§£SameSite Cookieæœºåˆ¶ã€‚<br />
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </div>
        <div class="code-demo">
            <el-row :gutter="20" class="grid-flex">
                <el-col :span="12">
                    <div class="grid-content bg-purple">
                        <el-row type="flex" justify="space-between" align="middle">
                            æ¼æ´ä»£ç  - CSRFä¿®æ”¹å¯†ç 
                            <div>
                                <el-button type="danger" round size="mini" @click="showVulnerableDialog">å»æµ‹è¯•</el-button>
                            </div>
                        </el-row>
                        <pre v-highlightjs><code class="java">/**
 * ä¿®æ”¹å¯†ç æ¥å£ - å­˜åœ¨CSRFæ¼æ´ï¼ˆæ¼”ç¤ºç”¨ï¼‰
 * åªéªŒè¯æ–°å¯†ç ï¼Œä¸éªŒè¯æ—§å¯†ç ï¼Œå®¹æ˜“è¢«CSRFæ”»å‡»
 */
@PostMapping("/csrf/changePasswordVuln")
public Result changePasswordVuln(@RequestBody Map&lt;String, String&gt; request, HttpServletRequest httpRequest) {
    String newPassword = request.get("newPassword");
    String token = httpRequest.getHeader("Authorization");
    
    // éªŒè¯JWT Tokenæ˜¯å¦å­˜åœ¨
    if (token == null || token.trim().isEmpty()) {
        return Result.error("æœªæˆæƒè®¿é—®");
    }
    
    try {
        // è·å–ç”¨æˆ·ID
        String cleanToken = token.startsWith("Bearer ") ? token.substring(7) : token;
        String userId = JwtUtils.parseJwt(cleanToken).get("id").toString();
        
        // ç›´æ¥ä¿®æ”¹å¯†ç ï¼Œä¸éªŒè¯æ—§å¯†ç  - å­˜åœ¨CSRFæ¼æ´
        boolean success = loginService.changePassword(userId, newPassword);
        
        if (success) {
            log.info("ç”¨æˆ·ID: {} å¯†ç ä¿®æ”¹æˆåŠŸï¼ˆCSRFæ¼æ´æ¼”ç¤ºæ¥å£ï¼‰", userId);
            return Result.success("å¯†ç ä¿®æ”¹æˆåŠŸ");
        } else {
            return Result.error("å¯†ç ä¿®æ”¹å¤±è´¥");
        }
    } catch (Exception e) {
        log.error("JWTè§£æå¤±è´¥", e);
        return Result.error("æœªæˆæƒè®¿é—®");
    }
}</code></pre>
                    </div>
                </el-col>
                <el-col :span="12">
                    <div class="grid-content bg-purple">
                        <el-row type="flex" justify="space-between" align="middle">
                            å®‰å…¨ä»£ç  - æ ¡éªŒæ—§å¯†ç ï¼ˆä¿®æ”¹å¯†ç åœºæ™¯ï¼‰
                            <div>
                                <el-button type="success" round size="mini" @click="showSecureDialog">å»æµ‹è¯•</el-button>
                            </div>
                        </el-row>
                        <pre v-highlightjs><code class="java">/**
 * ä¿®æ”¹å¯†ç æ¥å£ - CSRFé˜²æŠ¤ï¼ˆæ¼”ç¤ºç”¨ï¼‰
 * éªŒè¯æ—§å¯†ç ï¼Œé˜²æ­¢CSRFæ”»å‡»
 */
@PostMapping("/csrf/changePasswordSecure")
public Result changePasswordSecure(@RequestBody Map&lt;String, String&gt; request, HttpServletRequest httpRequest) {
    String oldPassword = request.get("oldPassword");
    String newPassword = request.get("newPassword");
    String token = httpRequest.getHeader("Authorization");
    
    // éªŒè¯JWT Tokenæ˜¯å¦å­˜åœ¨
    if (token == null || token.trim().isEmpty()) {
        return Result.error("æœªæˆæƒè®¿é—®");
    }
    
    try {
        // è·å–ç”¨æˆ·ID
        String cleanToken = token.startsWith("Bearer ") ? token.substring(7) : token;
        String userId = JwtUtils.parseJwt(cleanToken).get("id").toString();
        
        // éªŒè¯æ—§å¯†ç 
        if (oldPassword == null || oldPassword.trim().isEmpty()) {
            return Result.error("æ—§å¯†ç ä¸èƒ½ä¸ºç©º");
        }
        
        if (!loginService.verifyOldPassword(userId, oldPassword)) {
            log.warn("ç”¨æˆ·ID: {} å°è¯•ä¿®æ”¹å¯†ç ï¼Œä½†æ—§å¯†ç éªŒè¯å¤±è´¥ï¼ˆCSRFé˜²æŠ¤æ¼”ç¤ºï¼‰", userId);
            return Result.error("æ—§å¯†ç é”™è¯¯");
        }
        
        // ä¿®æ”¹å¯†ç 
        boolean success = loginService.changePasswordSecure(userId, oldPassword, newPassword);
        
        if (success) {
            log.info("ç”¨æˆ·ID: {} å¯†ç ä¿®æ”¹æˆåŠŸï¼ˆCSRFé˜²æŠ¤æ¼”ç¤ºæ¥å£ï¼‰", userId);
            return Result.success("å¯†ç ä¿®æ”¹æˆåŠŸ");
        } else {
            return Result.error("å¯†ç ä¿®æ”¹å¤±è´¥");
        }
    } catch (Exception e) {
        log.error("JWTè§£æå¤±è´¥", e);
        return Result.error("æœªæˆæƒè®¿é—®");
    }
}</code></pre>
                    </div>
                </el-col>
            </el-row>
            <el-row :gutter="20" class="grid-flex">
                <el-col :span="12">
                </el-col>
                <el-col :span="12">
                    <div class="grid-content bg-purple">
                        <el-row type="flex" justify="space-between" align="middle">
                            å®‰å…¨ä»£ç  - CSRF Tokenæœºåˆ¶é˜²å¾¡
                            <div>
                                <el-button type="success" round size="mini" @click="showTokenDialog">å»æµ‹è¯•</el-button>
                            </div>
                        </el-row>
                        <pre v-highlightjs><code class="java">/**
 * ç”ŸæˆCSRF Tokenæ¥å£
 * ç”¨äºæ¼”ç¤ºCSRF Tokenæœºåˆ¶
 */
@GetMapping("/csrf/generateToken")
public Result generateCsrfToken(HttpServletRequest httpRequest) {
    HttpSession session = httpRequest.getSession();
    
    // ç”Ÿæˆå”¯ä¸€çš„CSRF Token
    String csrfToken = UUID.randomUUID().toString();
    
    // å°†Tokenå­˜å‚¨åœ¨Sessionä¸­
    session.setAttribute("CSRF_TOKEN", csrfToken);
    
    log.info("ç”ŸæˆCSRF Token: {}", csrfToken);
    
    Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
    data.put("csrfToken", csrfToken);
    
    return Result.success(data);
}

/**
 * ä¿®æ”¹å¯†ç æ¥å£ - CSRF Tokené˜²æŠ¤ï¼ˆæ¼”ç¤ºç”¨ï¼‰
 * ä½¿ç”¨CSRF Tokenæœºåˆ¶é˜²æ­¢CSRFæ”»å‡»
 */
@PostMapping("/csrf/changePasswordWithToken")
public Result changePasswordWithToken(@RequestBody Map&lt;String, String&gt; request, HttpServletRequest httpRequest) {
    String newPassword = request.get("newPassword");
    String csrfToken = request.get("csrfToken");
    String token = httpRequest.getHeader("Authorization");
    
    // éªŒè¯JWT Tokenæ˜¯å¦å­˜åœ¨
    if (token == null || token.trim().isEmpty()) {
        return Result.error("æœªæˆæƒè®¿é—®");
    }
    
    try {
        // éªŒè¯CSRF Token
        HttpSession session = httpRequest.getSession();
        String sessionToken = (String) session.getAttribute("CSRF_TOKEN");
        
        if (sessionToken == null || !sessionToken.equals(csrfToken)) {
            log.warn("CSRF TokenéªŒè¯å¤±è´¥ï¼Session Token: {}, Request Token: {}", sessionToken, csrfToken);
            return Result.error("CSRF TokenéªŒè¯å¤±è´¥");
        }
        
        // è·å–ç”¨æˆ·ID
        String cleanToken = token.startsWith("Bearer ") ? token.substring(7) : token;
        String userId = JwtUtils.parseJwt(cleanToken).get("id").toString();
        
        // ä¿®æ”¹å¯†ç 
        boolean success = loginService.changePassword(userId, newPassword);
        
        if (success) {
            log.info("ç”¨æˆ·ID: {} å¯†ç ä¿®æ”¹æˆåŠŸï¼ˆCSRF Tokené˜²æŠ¤æ¼”ç¤ºæ¥å£ï¼‰", userId);
            
            // ä½¿ç”¨åé”€æ¯Tokenï¼ˆä¸€æ¬¡æ€§Tokenï¼‰
            session.removeAttribute("CSRF_TOKEN");
            
            return Result.success("å¯†ç ä¿®æ”¹æˆåŠŸ");
        } else {
            return Result.error("å¯†ç ä¿®æ”¹å¤±è´¥");
        }
    } catch (Exception e) {
        log.error("JWTè§£æå¤±è´¥", e);
        return Result.error("æœªæˆæƒè®¿é—®");
    }
}</code></pre>
                    </div>
                </el-col>
            </el-row>
        </div>

        <!-- æ¼æ´ä»£ç æµ‹è¯•å¯¹è¯æ¡† -->
        <el-dialog :visible.sync="vulnerableDialogVisible" width="80%" :show-close="false">
            <div slot="title" class="dialog-title">
                <span>CSRFæ”»å‡»æ¼”ç¤º - æ¶æ„ç½‘ç«™</span>
            </div>
            <div class="dialog-content">
                <div class="attack-explanation">
                    <h4>âš ï¸ CSRFæ”»å‡»åŸç†è¯´æ˜ï¼š</h4>
                    <p>ä¸‹é¢çš„"ç¤¼å“é¢†å–"å®é™…ä¸Šæ˜¯ä¸€ä¸ªCSRFæ”»å‡»æ¼”ç¤ºã€‚å½“æ‚¨ç‚¹å‡»å›¾ç‰‡æ—¶ï¼Œä¼šï¼š</p>
                    <ol>
                        <li>è‡ªåŠ¨å‘ç³»ç»Ÿå‘é€ä¿®æ”¹å¯†ç çš„è¯·æ±‚</li>
                        <li>åˆ©ç”¨æ‚¨å½“å‰çš„ç™»å½•çŠ¶æ€ï¼ˆJWT Tokenï¼‰</li>
                        <li>åœ¨æ‚¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä¿®æ”¹æ‚¨çš„å¯†ç </li>
                        <li>è¿™å°±æ˜¯å…¸å‹çš„CSRFæ”»å‡»åœºæ™¯</li>
                    </ol>

                    <h4>âš ï¸ è¡¥å……è¯´æ˜</h4>
                    <span style="color: red;">1ã€å› ä¸ºå½“å‰é¶åœºé¡¹ç›®çš„è®¤è¯ä¼šè¯æ˜¯JWTè€Œä¸æ˜¯Cookieï¼Œæ‰€ä»¥ä¸èƒ½åƒCookieæ–¹å¼é‚£æ ·é€šè¿‡å‘é€CSRF URLæ¥è¿›è¡Œæ”»å‡»ï¼Œå› æ­¤è¿™é‡Œä»…ä»…æ˜¯æ¨¡æ‹ŸCSRFçš„æ”»å‡»æ–¹å¼å’ŒåŸç†æ¼”ç¤ºã€‚</span> <br />
                    <span style="color: red;">2ã€å½“ä½ ç‚¹å‡»å›¾ç‰‡å®Œæˆæ”»å‡»åï¼Œä½ ç™»é™†é¶åœºçš„è´¦å·å¯†ç ä¼šä¿®æ”¹ä¸ºï¼šhacker123</span> 
                </div>
                
                <el-divider></el-divider>
                
                <div class="malicious-site">
                    <h2 style="color: #409EFF; text-align: center; margin-bottom: 20px;">ğŸ æ­å–œæ‚¨è·å¾—å…è´¹ç¤¼å“ï¼</h2>
                    
                    <!-- è¯±éª—å›¾ç‰‡ -->
                    <div class="gift-image-container" @click="performCSRFAttack">
                        <img 
                            src="https://img1.baidu.com/it/u=3200425930,2413475553&fm=253&fmt=auto&app=120&f=JPEG?w=800&h=800" 
                            alt="ç‚¹å‡»é¢†å–ç¤¼å“" 
                            class="gift-image"
                            title="ç‚¹å‡»å›¾ç‰‡é¢†å–å…è´¹ç¤¼å“"
                        />
                        <div class="gift-overlay">
                            <div class="gift-text">ğŸ ç‚¹å‡»é¢†å–ç¤¼å“</div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: #999; margin-top: 20px; font-size: 14px;">
                        * ç‚¹å‡»ä¸Šæ–¹å›¾ç‰‡å³å¯é¢†å–æ‚¨çš„å…è´¹ç¤¼å“
                    </p>
                </div>
                
                <div v-if="attackResult" class="attack-result">
                    <h4>æ”»å‡»ç»“æœï¼š</h4>
                    <el-alert :title="attackResult" :type="attackResultType" show-icon></el-alert>
                </div>
            </div>
        </el-dialog>

        <!-- å®‰å…¨ä»£ç æµ‹è¯•å¯¹è¯æ¡† -->
        <el-dialog :visible.sync="secureDialogVisible" width="80%" :show-close="false">
            <div slot="title" class="dialog-title">
                <span>CSRFé˜²æŠ¤æ¼”ç¤º - æ¶æ„ç½‘ç«™</span>
            </div>
            <div class="dialog-content">
                <div class="attack-explanation">
                    <h4>âš ï¸ CSRFé˜²æŠ¤åŸç†è¯´æ˜ï¼š</h4>
                    <p>ä¸‹é¢çš„"ç¤¼å“é¢†å–"å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªCSRFæ”»å‡»æ¼”ç¤ºã€‚ä½†æ˜¯è¿™æ¬¡ä¼šå¤±è´¥ï¼Œå› ä¸ºï¼š</p>
                    <ol>
                        <li>æœåŠ¡å™¨è¦æ±‚éªŒè¯æ—§å¯†ç æ‰èƒ½ä¿®æ”¹å¯†ç </li>
                        <li>æ”»å‡»è€…æ— æ³•è·å–ç”¨æˆ·çš„æ—§å¯†ç </li>
                        <li>å³ä½¿ç”¨æˆ·ç‚¹å‡»äº†æ¶æ„å›¾ç‰‡ï¼Œæ”»å‡»ä¹Ÿä¼šè¢«é˜»æ­¢</li>
                        <li>è¿™å°±æ˜¯æ ¡éªŒæ—§å¯†ç çš„CSRFé˜²æŠ¤æœºåˆ¶</li>
                    </ol>
                    
                    <h4>âš ï¸ è¡¥å……è¯´æ˜</h4>
                    <span style="color: red;">1ã€å› ä¸ºè¯¥é¡¹ç›®çš„è®¤è¯ä¼šè¯æ˜¯JWTæ–¹å¼è€Œä¸æ˜¯Cookieï¼Œæ‰€ä»¥ä¸èƒ½åƒCookieæ–¹å¼é‚£æ ·é€šè¿‡å‘é€CSRF URLæ¥è¿›è¡Œæ”»å‡»ã€‚è¿™é‡Œä»…ä»…æ˜¯æ¨¡æ‹ŸCSRFçš„æ”»å‡»æ–¹å¼å’ŒåŸç†æ¼”ç¤ºã€‚</span> <br />
                    <span style="color: red;">2ã€å½“ä½ ç‚¹å‡»å›¾ç‰‡å®Œæˆæ”»å‡»åï¼Œä½ ä¼šå‘ç°æ”»å‡»å¤±è´¥äº†ï¼Œå› ä¸ºç¼ºå°‘æ—§å¯†ç éªŒè¯</span>
                </div>
                
                <el-divider></el-divider>
                
                <div class="malicious-site">
                    <h2 style="color: #409EFF; text-align: center; margin-bottom: 20px;">ğŸ æ­å–œæ‚¨è·å¾—å…è´¹ç¤¼å“ï¼</h2>
                    
                    <!-- è¯±éª—å›¾ç‰‡ -->
                    <div class="gift-image-container" @click="performSecureCSRFAttack">
                        <img 
                            src="https://img1.baidu.com/it/u=3200425930,2413475553&fm=253&fmt=auto&app=120&f=JPEG?w=800&h=800" 
                            alt="ç‚¹å‡»é¢†å–ç¤¼å“" 
                            class="gift-image"
                            title="ç‚¹å‡»å›¾ç‰‡é¢†å–å…è´¹ç¤¼å“"
                        />
                        <div class="gift-overlay">
                            <div class="gift-text">ğŸ ç‚¹å‡»é¢†å–ç¤¼å“</div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: #999; margin-top: 20px; font-size: 14px;">
                        * ç‚¹å‡»ä¸Šæ–¹å›¾ç‰‡å³å¯é¢†å–æ‚¨çš„å…è´¹ç¤¼å“
                    </p>
                </div>
                
                <div v-if="protectionResult" class="attack-result">
                    <h4>é˜²æŠ¤ç»“æœï¼š</h4>
                    <el-alert :title="protectionResult" :type="protectionResultType" show-icon></el-alert>
                </div>
            </div>
        </el-dialog>

        <!-- CSRF Tokené˜²æŠ¤æµ‹è¯•å¯¹è¯æ¡† -->
        <el-dialog :visible.sync="tokenDialogVisible" width="80%" :show-close="false">
            <div slot="title" class="dialog-title">
                <span>CSRF Tokené˜²æŠ¤æ¼”ç¤º - æ¶æ„ç½‘ç«™</span>
            </div>
            <div class="dialog-content">
                <div class="attack-explanation">
                    <h4>âš ï¸ CSRF Tokené˜²æŠ¤åŸç†è¯´æ˜ï¼š</h4>
                    <p>CSRF Tokenæ˜¯æœ€é€šç”¨ã€æœ€å½»åº•çš„CSRFé˜²æŠ¤æœºåˆ¶ã€‚é˜²æŠ¤åŸç†ï¼š</p>
                    <ol>
                        <li>æœåŠ¡å™¨ä¸ºæ¯ä¸ªç”¨æˆ·ä¼šè¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ã€ä¸å¯é¢„æµ‹çš„Token</li>
                        <li>å‰ç«¯åœ¨å‘èµ·æ•æ„Ÿæ“ä½œæ—¶å¿…é¡»æºå¸¦è¿™ä¸ªToken</li>
                        <li>æœåŠ¡å™¨éªŒè¯Tokenæ˜¯å¦ä¸Sessionä¸­å­˜å‚¨çš„ä¸€è‡´</li>
                        <li>æ”»å‡»è€…æ— æ³•è·å–æˆ–ä¼ªé€ Tokenï¼Œå› æ­¤æ”»å‡»å¤±è´¥</li>
                        <li>Tokenä½¿ç”¨åå¯ä»¥é”€æ¯ï¼Œå½¢æˆä¸€æ¬¡æ€§Tokenæœºåˆ¶</li>
                    </ol>
                    
                    <h4>âš ï¸ è¡¥å……è¯´æ˜</h4>
                    <span style="color: red;">1ã€ä¸‹é¢æ¼”ç¤ºäº†CSRF Tokençš„å®Œæ•´æµç¨‹ï¼šè·å–Token â†’ æ¨¡æ‹Ÿæ”»å‡»</span> <br />
                    <span style="color: red;">2ã€æ‚¨ä¼šçœ‹åˆ°ï¼Œå³ä½¿ç‚¹å‡»æ¶æ„å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®çš„Tokenï¼Œæ”»å‡»ä¹Ÿä¼šå¤±è´¥</span> <br />
                    <span style="color: red;">3ã€å¦‚æœæµ‹è¯•ä¸‹é¢æä¾›çš„â€æ­£å¸¸ä¿®æ”¹å¯†ç â€œæŒ‰é’®ï¼Œä¼šæºå¸¦æ­£ç¡®çš„Tokenï¼Œå¯†ç ä¼šè¢«ä¿®æ”¹ä¸ºnewpassword</span>
                </div>
                
                <el-divider></el-divider>
                
                <div class="token-demo-section">
                    <h3 style="text-align: center; color: #409EFF; margin-bottom: 20px;">ğŸ” CSRF Tokenæ¼”ç¤º</h3>
                    
                    <!-- Tokenè·å–åŒºåŸŸ -->
                    <div class="token-get-section">
                        <h4>æ­¥éª¤1ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–CSRF Token</h4>
                        <p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·è®¿é—®é¡µé¢æ—¶ä¼šè‡ªåŠ¨ä»æœåŠ¡å™¨è·å–Tokenï¼ˆ<font color="red">ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·æµ‹è¯•ï¼Œæœ¬å¯¹è¯æ¡†æ‰“å¼€æ—¶å·²è‡ªåŠ¨è·å–</font>ï¼‰</p>
                        <div v-if="csrfToken" class="token-display">
                            <p><strong>âœ… CSRF Tokenå·²è·å–:</strong> <code>{{ csrfToken }}</code></p>
                        </div>
                        <div v-else class="token-display" style="background-color: #fff3cd; border-left-color: #ffc107;">
                            <p><strong>â³ æ­£åœ¨è·å–CSRF Token...</strong></p>
                        </div>
                    </div>
                    
                    <el-divider></el-divider>
                    
                    <!-- å¯¹æ¯”æµ‹è¯•åŒºåŸŸ -->
                    <div class="comparison-section">
                        <h4 style="color: #409EFF; margin-bottom: 10px;">æ­¥éª¤2ï¼šå¯¹æ¯”æµ‹è¯• - CSRF Tokené˜²æŠ¤æ•ˆæœ</h4>
                        
                        <el-row :gutter="20" style="margin-top: 20px;">
                            <!-- å·¦ä¾§ï¼šæ¶æ„æ”»å‡» -->
                            <el-col :span="12">
                                <div class="test-box attack-box">
                                    <h5 style="color: #f56c6c; text-align: center;">âŒ æ¶æ„CSRFæ”»å‡»ï¼ˆæœªæºå¸¦Tokenï¼‰</h5>
                                    <div class="malicious-site">
                                        <h2 style="color: #409EFF; text-align: center; margin-bottom: 15px; font-size: 18px;">ğŸ å…è´¹ç¤¼å“</h2>
                                        
                                        <!-- è¯±éª—å›¾ç‰‡ -->
                                        <div class="gift-image-container" @click="performTokenCSRFAttack">
                                            <img 
                                                src="https://img1.baidu.com/it/u=3200425930,2413475553&fm=253&fmt=auto&app=120&f=JPEG?w=800&h=800" 
                                                alt="ç‚¹å‡»é¢†å–ç¤¼å“" 
                                                class="gift-image-small"
                                                title="ç‚¹å‡»å›¾ç‰‡é¢†å–å…è´¹ç¤¼å“"
                                            />
                                            <div class="gift-overlay">
                                                <div class="gift-text-small">ğŸ ç‚¹å‡»é¢†å–</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </el-col>
                            
                            <!-- å³ä¾§ï¼šæ­£å¸¸è¯·æ±‚ -->
                            <el-col :span="12">
                                <div class="test-box normal-box">
                                    <h5 style="color: #67c23a; text-align: center;">âœ… æ­£å¸¸è¯·æ±‚ï¼ˆæºå¸¦æ­£ç¡®Tokenï¼‰</h5>
                                    <div class="normal-request">
                                        <p style="text-align: center; margin: 20px 0;">
                                            <i class="el-icon-circle-check" style="font-size: 60px; color: #67c23a;"></i>
                                        </p>
                                        <p style="text-align: center; color: #666; margin-bottom: 20px;">
                                            æ¨¡æ‹Ÿç”¨æˆ·æ­£å¸¸ä¿®æ”¹å¯†ç <br/>
                                            æºå¸¦æ­£ç¡®çš„CSRF Token
                                        </p>
                                        <div style="text-align: center;">
                                            <el-button type="success" @click="performNormalRequest" :disabled="!csrfToken">
                                                æ­£å¸¸ä¿®æ”¹å¯†ç 
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                            </el-col>
                        </el-row>
                    </div>
                </div>
                
                <div v-if="tokenResult" class="attack-result">
                    <h4>é˜²æŠ¤ç»“æœï¼š</h4>
                    <el-alert :title="tokenResult" :type="tokenResultType" show-icon></el-alert>
                </div>
            </div>
        </el-dialog>

    </div>
</template>

<script>
import { changePasswordVuln, changePasswordSecure, generateCsrfToken, changePasswordWithToken } from '@/api/csrf';

export default {
    data() {
        return {
            activeName: 'first',
            vulnerableDialogVisible: false,
            secureDialogVisible: false,
            tokenDialogVisible: false,
            attackResult: '',
            attackResultType: 'success',
            protectionResult: '',
            protectionResultType: 'success',
            tokenResult: '',
            tokenResultType: 'success',
            csrfToken: ''
        };
    },
    methods: {
        handleClick(tab, event) {
            // console.log(tab, event);
        },
        showVulnerableDialog() {
            this.vulnerableDialogVisible = true;
            this.attackResult = '';
        },
        showSecureDialog() {
            this.secureDialogVisible = true;
            this.protectionResult = '';
        },
        performCSRFAttack() {
            // æ¨¡æ‹ŸCSRFæ”»å‡»
            const attackData = {
                newPassword: 'hacker123'
            };
            
            changePasswordVuln(attackData)
                .then(response => {
                    this.attackResult = 'CSRFæ”»å‡»æˆåŠŸï¼å¯†ç å·²è¢«ä¿®æ”¹ä¸º: hacker123';
                    this.attackResultType = 'error';
                })
                .catch(error => {
                    this.attackResult = 'CSRFæ”»å‡»å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯');
                    this.attackResultType = 'warning';
                });
        },
        performSecureCSRFAttack() {
            // æ¨¡æ‹Ÿå¯¹å®‰å…¨æ¥å£çš„CSRFæ”»å‡»ï¼ˆä¸æä¾›æ—§å¯†ç ï¼‰
            const attackData = {
                newPassword: 'hacker123'
            };
            
            changePasswordSecure(attackData)
                .then(response => {
                    this.protectionResult = 'CSRFæ”»å‡»æˆåŠŸï¼è¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œå®‰å…¨æœºåˆ¶å¤±æ•ˆã€‚';
                    this.protectionResultType = 'error';
                })
                .catch(error => {
                    this.protectionResult = 'CSRFæ”»å‡»è¢«æˆåŠŸé˜»æ­¢ï¼åŸå› ï¼šç¼ºå°‘æ—§å¯†ç éªŒè¯ï¼Œå®‰å…¨æœºåˆ¶æœ‰æ•ˆé˜²æŠ¤ã€‚';
                    this.protectionResultType = 'success';
                });
        },
        showTokenDialog() {
            this.tokenDialogVisible = true;
            this.tokenResult = '';
            this.csrfToken = '';
            // æ‰“å¼€å¯¹è¯æ¡†æ—¶è‡ªåŠ¨è·å–CSRF Tokenï¼ˆæ¨¡æ‹Ÿæ­£å¸¸é¡µé¢åŠ è½½ï¼‰
            this.getCsrfToken();
        },
        getCsrfToken() {
            generateCsrfToken()
                .then(response => {
                    this.csrfToken = response.data.csrfToken;
                })
                .catch(error => {
                    console.error('CSRF Tokenè·å–å¤±è´¥', error);
                });
        },
        performTokenCSRFAttack() {
            // æ¨¡æ‹ŸCSRFæ”»å‡»ï¼ˆæ”»å‡»è€…æ— æ³•è·å–æ­£ç¡®çš„Tokenï¼Œå®Œå…¨ä¸æºå¸¦Tokenï¼‰
            const attackData = {
                newPassword: 'hacker123'
                // æ³¨æ„ï¼šè¿™é‡Œä¸æºå¸¦csrfTokenï¼Œæ¨¡æ‹ŸCSRFæ”»å‡»
            };
            
            changePasswordWithToken(attackData)
                .then(response => {
                    this.tokenResult = 'âŒ CSRFæ”»å‡»æˆåŠŸï¼è¿™ä¸åº”è¯¥å‘ç”Ÿï¼ŒTokenæœºåˆ¶å¤±æ•ˆã€‚';
                    this.tokenResultType = 'error';
                })
                .catch(error => {
                    this.tokenResult = 'âœ… CSRFæ”»å‡»è¢«æˆåŠŸé˜»æ­¢ï¼åŸå› ï¼šæœªæºå¸¦CSRF Tokenï¼Œæ”»å‡»è€…æ— æ³•è·å–æˆ–ä¼ªé€ æ­£ç¡®çš„Tokenã€‚';
                    this.tokenResultType = 'success';
                });
        },
        performNormalRequest() {
            // æ¨¡æ‹Ÿæ­£å¸¸è¯·æ±‚ï¼ˆä½¿ç”¨æ­£ç¡®çš„Tokenï¼‰
            if (!this.csrfToken) {
                this.$message.error('è¯·å…ˆè·å–CSRF Token');
                return;
            }
            
            const normalData = {
                newPassword: 'newpassword',
                csrfToken: this.csrfToken  // ä½¿ç”¨æ­£ç¡®çš„Token
            };
            
            changePasswordWithToken(normalData)
                .then(response => {
                    this.tokenResult = `âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼æ–°å¯†ç ä¸º: ${normalData.newPassword}ã€‚æ­£ç¡®çš„CSRF Tokené€šè¿‡éªŒè¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„ç”¨æˆ·æ“ä½œã€‚`;
                    this.tokenResultType = 'success';
                    // æˆåŠŸåéœ€è¦é‡æ–°è·å–Tokenï¼ˆä¸€æ¬¡æ€§Tokenï¼‰
                    setTimeout(() => {
                        this.getCsrfToken();
                    }, 2000);
                })
                .catch(error => {
                    this.tokenResult = 'âŒ å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯');
                    this.tokenResultType = 'error';
                });
        }
    }
};
</script>

<style>
.vuln-info {
    border-radius: 10px;
    margin-left: 20px;
    margin-right: 20px;
    margin-bottom: 20px;
    margin-top: 10px;
}

.header-div {
    font-size: 24px;
    color: #409EFF;
    font-weight: bold;
    padding: 10px;
    justify-content: center;
    align-items: center;
    border-bottom: 1px solid #ccc;
}

.body-div {
    padding: 10px;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    font-size: 14px;
}

.vuln-detail {
    background-color: #dce9f8;
    padding: 10px;
}

.code-demo {
    margin: 20px;
    border-top: 1px solid #ccc;
    padding-top: 20px;
}

pre code {
    font-size: 12px;
}

.el-row {
    margin-bottom: 20px;
}

.el-row:last-child {
    margin-bottom: 0;
}

.el-col {
    border-radius: 4px;
}

.bg-purple {
    background: #d3dce6;
}

.grid-content {
    border-radius: 4px;
    height: 100%;
    padding: 10px;
}

.grid-flex {
    display: flex;
    align-items: stretch;
}

.dialog-content {
    padding: 20px;
}

.dialog-title {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    color: #303133;
}

.attack-demo, .protection-demo {
    margin: 20px 0;
    padding: 15px;
    background-color: #f5f7fa;
    border-radius: 5px;
}

.attack-buttons, .protection-buttons {
    margin-top: 15px;
}

.attack-result, .protection-result {
    margin-top: 20px;
}

.protection-form {
    margin: 15px 0;
}

.sql-param {
    color: red;
    font-weight: bold;
}

/* æ¶æ„ç½‘ç«™æ ·å¼ */
.malicious-site {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 10px;
    margin-bottom: 20px;
}

.gift-image-container {
    position: relative;
    display: inline-block;
    cursor: pointer;
    transition: transform 0.3s ease;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.gift-image-container:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.gift-image {
    width: 300px;
    height: 300px;
    object-fit: cover;
    display: block;
}

.gift-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.gift-image-container:hover .gift-overlay {
    opacity: 1;
}

.gift-text {
    color: white;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.attack-explanation {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 5px;
    padding: 15px;
    margin-top: 20px;
}

.attack-explanation h4 {
    color: #856404;
    margin-bottom: 10px;
}

.attack-explanation ol {
    color: #856404;
    margin: 10px 0;
}

.attack-explanation p {
    color: #856404;
    margin: 10px 0;
}

.token-demo-section {
    padding: 20px;
    background-color: #f5f7fa;
    border-radius: 10px;
    margin: 20px 0;
}

.token-get-section {
    padding: 15px;
    background-color: #fff;
    border-radius: 5px;
    margin-bottom: 20px;
}

.token-get-section h4 {
    color: #409EFF;
    margin-bottom: 10px;
}

.token-display {
    margin-top: 15px;
    padding: 15px;
    background-color: #f0f9ff;
    border-left: 4px solid #409EFF;
    border-radius: 4px;
}

.token-display code {
    background-color: #e6f7ff;
    padding: 2px 8px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    color: #1890ff;
    word-break: break-all;
}

.comparison-section {
    margin-top: 20px;
}

.test-box {
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    min-height: 320px;
    display: flex;
    flex-direction: column;
}

.attack-box {
    background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
    border: 2px solid #f56c6c;
}

.normal-box {
    background: linear-gradient(135deg, #f0f9ff 0%, #fff 100%);
    border: 2px solid #67c23a;
}

.test-box h5 {
    margin-top: 0;
    margin-bottom: 15px;
}

.gift-image-small {
    width: 100%;
    max-width: 150px;
    height: auto;
    cursor: pointer;
    border-radius: 8px;
    transition: transform 0.3s ease;
}

.gift-image-small:hover {
    transform: scale(1.05);
}

.gift-text-small {
    font-size: 14px;
    font-weight: bold;
    color: white;
}

.normal-request {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
</style>
